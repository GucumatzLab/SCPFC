<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:b="http://bootsfaces.net/ui"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:f="http://java.sun.com/jsf/core">
  <ui:composition template="WEB-INF/plantilla.xhtml">
    <ui:define name="titulo">SCPFC | <h:outputText value="#{visorPuesto.puesto.nombre}"/></ui:define>

    <ui:define name="contenido">
        <f:metadata>
            <f:viewParam id="id" name="id" value="#{visorPuesto.id}"/>
            <f:viewAction action="#{visorPuesto.obtenerPuesto}" />
        </f:metadata>
      <style>
        #gmap {
          height: 500px;
          width: 100%;
          float: left;
        }
      </style>

      <b:row>
        <b:column span="6">
          <p:gmap id="gmap" center="#{visorPuesto.puesto.latitud}, #{visorPuesto.puesto.longitud}" zoom="20"
                  type="HYBRID" model="#{mapa.advancedModel}"
                  widgetVar="map">
            <p:ajax event="overlaySelect" listener="#{mapa.onMarkerSelect}"/>
            <p:gmapInfoWindow id="infoWindow">
              <p:outputPanel style="text-align: center; display: block; margin: auto">
                <h:outputText value="#{mapa.marker.title}" />
                <br/>
                <h:button value="Ver Detalles" outcome="DetallesPuesto.xhtml?id=#{mapa.marker.data.id}" />
              </p:outputPanel>
            </p:gmapInfoWindow>    
          </p:gmap>
        </b:column>

        <h:inputHidden id="pLat" value="#{visorPuesto.puesto.latitud}" />
        <h:inputHidden id="pLng" value="#{visorPuesto.puesto.longitud}" />
        <h:inputHidden id="pNom" value="#{visorPuesto.puesto.nombre}" />

        <b:column span="6">
          <b:row rendered="#{not empty visorPuesto.puesto.fotosPuesto}">
            <center>
              <b:carousel id="cfotos">
                <c:forEach items="#{visorPuesto.puesto.fotosPuesto}" var="fppk">
                  <b:carouselItem>
                    <p:graphicImage value="#{manejadorDeImagenes.imagenDeArchivo}" style="height: 300px">
                      <f:param name="ruta" value="#{fppk.url}"/>
                    </p:graphicImage>
                  </b:carouselItem>
                </c:forEach>
              </b:carousel>
            </center>
          </b:row>
          <b:row>
            <center>
              <h1><h:outputText value="#{visorPuesto.puesto.nombre}"/></h1>
            </center>
            <p><b>Ubicación: </b> <h:outputText value="#{visorPuesto.puesto.ubicacion}"/></p>
            <p><b>Tipo de comida: </b> <h:outputText value="#{visorPuesto.puesto.tipoComida}"/></p>
          </b:row>

          <b:row>
            <p:rating id="calificacion" value="#{visorPuesto.getPromedioCalificacion()}" style="width: 96px; margin: 0 auto;" readonly="true"/>
          </b:row>

          <h:form styleClass="form-signin" prependId="false" rendered="#{sesionActiva.haySesionActiva}">
            <center>
              <b:row>
                <!-- Botón para el overlay de comentar -->
                <p:commandButton value="Comentar" type="button" onclick="PF('comOverlay').show();"/>
                <p:dialog header="Comentar" widgetVar="comOverlay" height="250" width="400">
                  <b:row>
                    <b:column col-xs="12" col-sm="12" col-md="12" col-lg="12">
                      <br/>
                      <br/>
                      <b:inputTextarea placeholder="Comenta aquí..." value="#{comBean.comentario}"/>
                    </b:column>
                  </b:row>
                  <b:row>
                    <br/>
                    <br/>
                    <b:commandButton look="primary btn-block" value="Agregar" size="lg" action="#{comBean.agregarComentario()}" onclick="PF('comOverlay').hide();">
                      <p:ajax process="@form" update=":mensajes :comentarios"/>
                    </b:commandButton>
                  </b:row>
                </p:dialog>

                <!-- Botón para el overlay de calificar -->
                <p:commandButton value="Calificar" type="button" onclick="PF('calOverlay').show();"/>
                <p:dialog header="Calificar" widgetVar="calOverlay" height="200" width="400">
                  <b:row>
                    <b:column col-xs="12" col-sm="12" col-md="12" col-lg="12">
                      <div align="center" draggable="false">
                        <h:outputText value="Calificación"/>
                      </div>
                      <br/>
                      <br/>
                      <p:rating value="#{calBean.calificacion}" style="width: 96px; margin: 0 auto;"/>
                    </b:column>
                  </b:row>
                  <b:row>
                    <br/>
                    <br/>
                    <b:commandButton look="primary btn-block" value="Agregar" size="lg" action="#{calBean.agregarCalificacion()}" onclick="PF('calOverlay').hide();">
                      <p:ajax process="@form" update=":mensajes :calificacion"/>
                    </b:commandButton>
                  </b:row>
                </p:dialog>
              </b:row>
            </center>
          </h:form>

        </b:column>
      </b:row>

      <b:row id="comentarios">
        <b:column span="8" offset="2">
          <h2>Comentarios</h2>
          <h:form>
          <b:row rendered="#{empty visorPuesto.puesto.comentarios}">
            <p>No hay comentarios sobre este puesto.</p>
          </b:row>

          <ui:repeat value="#{visorPuesto.puesto.comentarios}" var="c">
            <b:panel collapsible="true">
              <b:row>
                <b:column span="3">
                  <center>
                    <b:row>
                      <p:graphicImage styleClass="imgCirculo"
                                      value="#{manejadorDeImagenes.fotoDeUsuario}">
                        <f:param name="rutaImagen" value="#{c.usuario.rutaImagen}"/>
                      </p:graphicImage>
                    </b:row>
                    <b:row>
                      #{c.usuario.nombre}
                    </b:row>
                    <b:row>
                      <h:outputText value="#{c.fecha}">
                        <f:convertDateTime type="both"/>
                      </h:outputText>
                    </b:row>
                  </center>
                </b:column>

                <b:column span="9" style="white-space: pre">#{c.comentario}</b:column>
                <b:column span="1" rendered="#{sesionActiva.haySesionActiva}"><b:commandButton action="#{visorPuesto.enviaMensaje(sesionActiva.obtenerUsuarioActual(),c.usuario,c,visorPuesto.puesto)}" iconAwesome="fa-bell-o" tooltip="Reportar este comentario como ofensivo o inapropiado" look="warning"/></b:column>
              </b:row>
            </b:panel>
          </ui:repeat>
          </h:form>
        </b:column>
      </b:row>

    <script type="text/javascript">
        $( document ).ready(function() {
            pLat = document.getElementById('pLat').value;
            pLng = document.getElementById('pLng').value;
            pNom = document.getElementById('pNom').value;
            
            starMarker = new google.maps.Marker({
                position:new google.maps.LatLng(pLat, pLng),
                icon: 'http://maps.google.com/mapfiles/kml/paddle/red-stars.png',
                animation: google.maps.Animation.DROP
            });
            
            PF('map').addOverlay(starMarker);
        });
    </script>
    </ui:define>
  </ui:composition>
</html>
